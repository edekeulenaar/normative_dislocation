<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The 100 most engaged social media posts leading up to the January 8th riots in Brasília (2022-2023)</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<!-- Fonts from your repo -->
<style>
@font-face{
  font-family:"SchulbuchNord";
  src:url("https://raw.githubusercontent.com/edekeulenaar/normative_dislocation/main/SchulbuchNord-Normal.otf") format("opentype");
  font-weight:400; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"SchulbuchSued";
  src:url("https://raw.githubusercontent.com/edekeulenaar/normative_dislocation/main/SchulbuchSued-Fett.otf") format("opentype");
  font-weight:700; font-style:normal; font-display:swap;
}
</style>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1622; --stroke:#213248; --fg:#e6eef7; --muted:#9fb3c8; --accent:#7cc4ff;
    --sep:#101621;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:"SchulbuchNord",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  b,strong{font-family:"SchulbuchSued","SchulbuchNord",sans-serif;font-weight:700}

  /* Layout */
  .wrap{max-width:1850px;margin:24px auto 90px;padding:0 16px}
  header h1{
    margin:.2rem 0 2.2rem;
    font-size:30px; line-height:1.16;
    font-family:"SchulbuchNord",serif;
    letter-spacing:.2px;
  }

  /* Controls */
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:12px}
  .pill{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:#0e1520;color:var(--fg);font-size:15px}
  select,input[type="date"],button{border-radius:12px;border:1px solid var(--stroke);background:#0e1520;color:var(--fg);padding:10px 12px;font-weight:700;font-family:"SchulbuchSued"; font-size:15px}
  #search{flex:1;background:#0e1520;color:var(--fg);border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-size:15px}

  /* Legends */
  .legend-top{display:block;margin-top:16px}
  .legend-top .section{border:1px solid var(--stroke);border-radius:14px;padding:14px 14px 16px;background:#0e1520;margin-bottom:14px}
  .legend-top h3{font-size:15px;margin:0 0 12px;color:var(--muted);font-weight:700;font-family:"SchulbuchSued"}
  .legend-top .legend-row{display:flex;flex-wrap:wrap;gap:12px 18px;align-items:center}
  .legend-item{display:flex;align-items:center;gap:10px;font-size:14px;color:var(--fg);cursor:pointer}
  .legend-item .swatch{width:16px;height:16px;border-radius:50%;border:1.5px solid #fff3}
  .legend-item .stroke{border-radius:4px;height:12px;width:26px;background:transparent}
  .legend-item.dim{opacity:.35}
  .legend-loading{color:#9fb3c8;font-size:14px}
  .size-chips{display:flex;flex-wrap:wrap;gap:12px 18px}
  .chip{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;background:#0e1520;color:#9fb3c8;font-size:14px;white-space:nowrap}
  .chip svg{width:48px;height:16px}
  .story-item{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--stroke);border-radius:14px;background:#0e1520;color:var(--fg);cursor:pointer;font-size:14px}
  .story-item.active{outline:2px solid #6fa7ff}

  .viz{margin-top:20px;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:14px}
  svg{width:100%;height:auto;display:block}

  /* Axes */
  .axis text{fill:var(--fg);font-size:25px;font-family:"SchulbuchSued"}
  .axis path,.axis line{stroke:#33465e}
  .grid-v line{stroke:#1c2a3c;stroke-width:1;opacity:.6}

  /* Row/platform labels (left side) */
  .platform-name{ fill:#e6eef7; font-family:"SchulbuchSued"; font-size:20px; letter-spacing:.5px; }

  /* Dots / rings */
  .ring-sep{stroke:var(--sep)}

  /* Context chips + expanded cards (bigger) */
  .chip-g rect{fill:#0b1220;stroke:#6fa7ff;stroke-width:1.6}
  .chip-g text{fill:#e6eef7;font-size:22px}         /* larger chip label */

  .xchip rect{fill:#0b1220;stroke:#6fa7ff;stroke-width:2}
  .xchip text{fill:#e6eef7;font-size:22px}          /* larger card text */
  .xbtn{fill:#cfe2ff;font-size:28px;cursor:pointer} /* bigger close */
  .panel-title{fill:#9fb3c8;font-size:20px;font-family:"SchulbuchSued"}

  /* Tooltip (post hover) */
  .tool{
    position:absolute;pointer-events:none;background:#0d1521;color:var(--fg);
    border:1px solid var(--stroke);border-radius:14px;padding:18px 20px;
    font-size:15px;line-height:1.5;max-width:640px;box-shadow:0 10px 30px #0006
  }
  .hidden{display:none}
  .dimStory{opacity:.25}
  .loading{fill:#9fb3c8;font-size:14px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>The 100 most engaged social media posts leading up to the January 8th riots in Brasília (2022-2023)</h1>
  </header>

  <div class="controls">
    <label class="pill">Annotation language
      <select id="anno-lang"><option value="en" selected>English</option><option value="pt">Português</option></select>
    </label>
    <label class="pill">Post language
      <select id="post-lang"><option value="pt">Português</option><option value="en" selected>English</option></select>
    </label>
    <label class="pill">From <input id="from-date" type="date"/></label>
    <label class="pill">To <input id="to-date" type="date"/></label>
    <button id="apply-range" class="pill" style="cursor:pointer">Apply range</button>
    <input id="search" placeholder="Search (post / theme / status / link)"/>
  </div>

  <div class="legend-top">
    <div class="section">
      <h3>What you are seeing</h3>
      <div id="size-chips" class="size-chips"></div>
    </div>

    <div class="section">
      <h3>Stories</h3>
      <div id="legend-stories" class="legend-row"></div>
    </div>

    <div class="section">
      <h3>Themes (click to filter)</h3>
      <div id="legend-themes" class="legend-row"><span class="legend-loading">Loading…</span></div>
    </div>

    <div class="section">
      <h3>Sub‑themes (click to filter)</h3>
      <div id="legend-subthemes" class="legend-row"><span class="legend-loading">Loading…</span></div>
    </div>

    <div class="section">
      <h3>Status (click to filter)</h3>
      <div id="legend-status" class="legend-row"><span class="legend-loading">Loading…</span></div>
    </div>
  </div>

  <div class="viz">
    <svg id="chart" viewBox="0 0 2400 1900" preserveAspectRatio="xMidYMid meet" aria-label="Beeswarm chart"></svg>
  </div>
</div>

<div id="tooltip" class="tool hidden"></div>

<script>
(() => {
  /* ---------- Layout numbers ---------- */
  const SIDE_W = 640;     // sidebar width
  const GAP_W  = 140;     // gap between plot and sidebar
  const PLOT_W = 1650;    // swarm width
  const W = 160 + PLOT_W + GAP_W + SIDE_W + 40;
  const M = { t: 240, r: 30, b: 120, l: 160 };
  const rowH = 200, rowGap = 160;

  const DEFAULT_CSV_URL = "https://raw.githubusercontent.com/edekeulenaar/normative_dislocation/main/Annex%20-%20Beeswarm%20graph%20(Top%20~500%20per%20platform)%20-%2031%20Oct-10%20Jan%202023%20-%20Final%20spreadsheet%20for%20article%20viz.csv";
  const CSV_URL = new URLSearchParams(location.search).get('csv') || DEFAULT_CSV_URL;

  const COLS = {
    date:['Date'],
    anno_en:['Annotation','Annotations','Annotations (English)'],
    anno_pt:['Annotation in Portuguese','Annotations in Portuguese'],
    platform:['Platform'],
    engagement:['Overall engagement'],
    post_pt:['Post in Portuguese'],
    post_en:['Post in English'],
    theme:['Theme'],
    subtheme:['Sub-theme','Subtheme'],
    detailed_status:['Detailed status as of January 18'],
    summarised_status:['Summarised status'],
    annex:['Annex','Appendix'],
    link:['URL','Link'],
    story:['Story']
  };

  // Theme colors
  const THEME_COLOR = new Map([
    ['Allegations of election fraud', '#E0F3A1'],
    ['Strikes in support of a military coup', '#FEDD8D'],
    ['Calls for a military intervention', '#F99858'],
    ['Calls to join the January 8 riots', '#DE4D4A'],
    ['References to, or calls for, a civil war', '#9E0142'],
    ['Prophecising a coup', '#FDF3A9'],
    ['Other', '#9aa3ad']
  ]);
  const colorForTheme = t => THEME_COLOR.get(t) || THEME_COLOR.get('Other');

  const STATUS_COLORS = new Map([
    ['Removed by the user',    '#C96918'],
    ['Removed by platform',    '#E1524A'],
    ['Removed by the platform','#E1524A'],
    ['Removed',                '#E1524A'],
    ['Labelled',               '#FFBD4A'],
    ['Labeled',                '#FFBD4A'],
    ['Online',                 'transparent'],
    ['Unknown',                '#9aa8bb']
  ]);
  const statusColor = st => STATUS_COLORS.get(st) ?? '#9aa8bb';
  const isGETTR = d => (d.platform||'').toLowerCase()==='gettr';

  // Stories (display names)
  const STORY_PLANNING = 'Planning the riots';
  const STORY_MILITARY = 'Military involvement';
  const STORY_FRAUD    = 'Allegations of electoral fraud';

  // Membership rules
  const planningThemes = new Set([
    'Calls for a military intervention',
    'Calls to join the January 8 riots',
    'Prophecising a coup',
    'References to, or calls for, a civil war',
    'Strikes in support of a military coup'
  ]);
  const militarySubthemes = new Set(['Military support','Military barracks']);

  // Engagement labels
  const ENG_LABEL = new Map([
    ['Telegram', 'Total views and shares'],
    ['GETTR', 'No engagement'],
    ['Twitter', 'Likes, retweets and replies'],
    ['YouTube', 'Views and comments'],
    ['Facebook', 'Shares and replies'],
    ['Instagram', 'Shares and replies']
  ]);

  /* ---------- SVG scaffolding ---------- */
  const $svg = d3.select('#chart').attr('viewBox',`0 0 ${W} ${M.t + 6*(rowH+rowGap) + M.b}`);
  const defs=$svg.append('defs');
  defs.append('marker').attr('id','arrow').attr('viewBox','0 0 10 10')
    .attr('refX',10).attr('refY',5).attr('markerWidth',8).attr('markerHeight',8).attr('orient','auto')
    .append('path').attr('d','M 0 0 L 10 5 L 0 10 z').attr('fill','#6fa7ff');

  const gRoot=$svg.append('g').attr('transform',`translate(${M.l},${M.t})`);
  const gPlot=gRoot.append('g');
  const gAxisTop=gPlot.append('g').attr('class','axis');
  const gAxisBottom=gPlot.append('g').attr('class','axis');
  const gGridV=gPlot.append('g').attr('class','grid-v');
  const gRows=gPlot.append('g');
  const gLabels=gPlot.append('g');
  const gLines=gRoot.append('g');     // connectors
  const gSide=gRoot.append('g');      // chips columns
  const gOverlay=gRoot.append('g');   // expanded cards

  const tooltip=document.getElementById('tooltip');

  // State
  const S={raw:[],data:[],platforms:[],themes:new Set(),subthemes:new Set(),statuses:new Set(),
           activeStory:'All',themeFilter:new Set(),subthemeFilter:new Set(),statusFilter:new Set(),
           search:'',annoLang:'en',postLang:'en',from:null,to:null};

  // Initialize legend placeholders
  document.getElementById('legend-themes').innerHTML='<span class="legend-loading">Loading…</span>';
  document.getElementById('legend-subthemes').innerHTML='<span class="legend-loading">Loading…</span>';
  document.getElementById('legend-status').innerHTML='<span class="legend-loading">Loading…</span>';

  // Controls
  document.getElementById('anno-lang').onchange=e=>{S.annoLang=e.target.value; rebuildSidebars();};
  document.getElementById('post-lang').onchange=e=>{S.postLang=e.target.value;};
  document.getElementById('apply-range').onclick=applyRange;
  let deb; document.getElementById('search').addEventListener('input',()=>{clearTimeout(deb);deb=setTimeout(()=>{S.search=(document.getElementById('search').value||'').toLowerCase().trim(); filter(true);},160)});

  // Helpers
  const esc = s => (s==null?'':String(s)).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  function col(r,keys){for(const k of keys){if(r[k]!=null&&String(r[k]).trim()!=='')return String(r[k]).trim();}return'';}
  function num(r,keys){const v=col(r,keys);if(v==='')return NaN;const nv=+String(v).replace(/\u00A0/g,' ').replace(/[^\d.\-]/g,'');return isFinite(nv)?nv:NaN;}
  function parseDate(s){if(!s)return null;let d=new Date(s);if(!isNaN(+d))return d;const fmts=['%Y-%m-%d %H:%M:%S','%Y-%m-%d','%d/%m/%Y %H:%M','%d/%m/%Y'];for(const f of fmts){const p=d3.timeParse(f);d=p(s);if(d)return d;}return null;}
  function datumVisible(d){
    if(S.themeFilter.size && !S.themeFilter.has(d.theme)) return false;
    if(S.statusFilter.size && !S.statusFilter.has(d.summarised_status)) return false;
    if(S.subthemeFilter.size && !S.subthemeFilter.has(d.subtheme)) return false;
    if(S.search){
      const hay=[d.post_en,d.post_pt,(d.context_en||''),(d.context_pt||''),d.theme,d.subtheme,d.summarised_status,d.link,d.annex].join(' ').toLowerCase();
      if(!hay.includes(S.search)) return false;
    }
    return true;
  }

  // Load CSV
  fetch(CSV_URL,{cache:"no-store"}).then(r=>r.text()).then(text=>{
    const header=(text.split(/\r?\n/)[0]||""); const delim=header.includes(";")?";":",";
    const rows=d3.dsvFormat(delim).parse(text); ingest(rows);
  }).catch(err=>console.error(err));

  function ingest(rows){
    const clean=rows.map((r,i)=>{
      const date=parseDate(col(r,COLS.date)); if(!date) return null;
      const sRaw=(col(r,COLS.story)||'').trim();
      const story = sRaw==='Story 1' ? STORY_PLANNING : sRaw==='Story 2' ? STORY_MILITARY : sRaw==='Story 3' ? STORY_FRAUD : sRaw;
      const engagement_raw = col(r,COLS.engagement);
      const engagement_num = num(r,COLS.engagement);
      return {
        uid:i,date,platform:col(r,COLS.platform)||'Unknown',
        engagement_raw,engagement_num,
        theme:col(r,COLS.theme)||'Other',subtheme:col(r,COLS.subtheme)||'—',
        post_en:col(r,COLS.post_en),post_pt:col(r,COLS.post_pt),
        context_en:col(r,COLS.anno_en),context_pt:col(r,COLS.anno_pt),
        story,detailed_status:col(r,COLS.detailed_status),
        summarised_status:col(r,COLS.summarised_status)||'Unknown',
        annex:col(r,COLS.annex),link:col(r,COLS.link)
      };
    }).filter(Boolean);

    S.raw=clean;
    const desired=['Telegram','GETTR','Twitter','YouTube','Facebook','Instagram'];
    const present=Array.from(new Set(clean.map(d=>d.platform)));
    S.platforms = desired.filter(p=>present.includes(p)).concat(present.filter(p=>!desired.includes(p)));
    S.themes=new Set(clean.map(d=>d.theme).filter(Boolean));
    S.subthemes=new Set(clean.map(d=>d.subtheme).filter(Boolean));
    S.statuses=new Set(clean.map(d=>d.summarised_status).filter(Boolean));

    const min=d3.min(clean,d=>d.date), max=d3.max(clean,d=>d.date);
    const iso=d=>d.toISOString().slice(0,10);
    document.getElementById('from-date').value=iso(min);
    document.getElementById('to-date').value=iso(max);
    S.from=min; S.to=max;

    buildStoriesLegend();
    rebuild();
  }

  let xScale, rByPlat, posByUid=new Map(), maxByPlat=new Map();

  function rebuild(){
    S.data=S.raw.filter(d=>(!S.from||d.date>=S.from)&&(!S.to||d.date<=S.to));
    const tMin=d3.min(S.data,d=>d.date), tMax=d3.max(S.data,d=>d.date);
    const innerH=S.platforms.length*(rowH+rowGap);
    d3.select('#chart').attr('viewBox',`0 0 ${W} ${M.t+innerH+M.b}`);

    xScale=d3.scaleTime().domain([tMin,tMax]).range([0,PLOT_W]);

    // per‑platform max (ignore '?')
    maxByPlat=d3.rollup(
      S.data.filter(d=>isFinite(d.engagement_num)&&d.engagement_num>0),
      v=>d3.max(v,d=>d.engagement_num)||1,
      d=>d.platform
    );
    rByPlat=new Map(S.platforms.map(p=>{
      const mx=maxByPlat.get(p)||1;
      const lohi=(p.toLowerCase()==='gettr')?[1.6,4.0]:[3,11];
      return [p,d3.scaleSqrt().domain([1,mx]).range(lohi)];
    }));

    // axes & grid
    const fmtTop=d3.timeFormat('%b %d');
    gAxisTop.selectAll('*').remove();
    gAxisTop.attr('transform','translate(0,-64)').call(d3.axisTop(xScale).ticks(10).tickFormat(d=>fmtTop(d).toUpperCase()));
    gAxisTop.selectAll('text').attr('font-size',25);

    gAxisBottom.selectAll('*').remove();
    gAxisBottom.attr('transform',`translate(0,${innerH+44})`).call(d3.axisBottom(xScale).ticks(10).tickFormat(d=>fmtTop(d).toUpperCase()));
    gAxisBottom.selectAll('text').attr('font-size',25);

    gGridV.selectAll('*').remove();
    gGridV.attr('transform','translate(0,-44)');
    const ticks=xScale.ticks(10);
    gGridV.selectAll('line').data(ticks).join('line')
      .attr('x1',d=>xScale(d)).attr('x2',d=>xScale(d)).attr('y1',0).attr('y2',innerH+60);

    // platform labels
    gLabels.selectAll('*').remove();
    S.platforms.forEach((p,i)=>{
      gLabels.append('text')
        .attr('class','platform-name')
        .attr('x',-24)
        .attr('y',i*(rowH+rowGap)+rowH/2+6)
        .attr('text-anchor','end')
        .text(p.toUpperCase());
    });

    // rows + dots
    const rowSel=gRows.selectAll('g.row').data(S.platforms,d=>d);
    const rowEnter=rowSel.enter().append('g').attr('class','row');
    const rowAll=rowEnter.merge(rowSel).attr('transform',(d,i)=>`translate(0,${i*(rowH+rowGap)+rowH/2})`);
    rowAll.selectAll('*').remove();

    posByUid.clear();
    if (S.activeStory!=='All') showLoadingSidebars();

    let pending=0;
    rowAll.each(function(plat,iRow){
      const rowBaseY=iRow*(rowH+rowGap)+rowH/2;
      const rScale=rByPlat.get(plat);
      const nodes=S.data.filter(d=>d.platform===plat).map(d=>{
        const r=isFinite(d.engagement_num)?(rScale?.(Math.max(1,d.engagement_num))||5):(rScale?.(1)||4);
        return {...d,r,x:xScale(d.date),y:0};
      });

      const sel=d3.select(this).selectAll('g.dot').data(nodes,d=>d.uid);
      const gDot=sel.join(enter=>{
        const g=enter.append('g').attr('class','dot').attr('tabindex',0)
          .on('mouseenter',(e,d)=>showTooltip(e,d))
          .on('mouseleave',hideTooltip)
          .on('focus',(e,d)=>showTooltip(e,d))
          .on('blur',hideTooltip)
          .on('click',(e,d)=>openDetails(d));
        g.append('circle').attr('class','ring-status').attr('fill','none').attr('stroke-width',3.2);
        g.append('circle').attr('class','ring-sep').attr('fill','none').attr('stroke-width',2.2);
        g.append('circle').attr('class','core').attr('stroke','none');
        return g;
      });

      const sim=d3.forceSimulation(nodes)
        .force('x',d3.forceX(d=>xScale(d.date)).strength(0.85))
        .force('y',d3.forceY(0).strength(0.16))
        .force('collide',d3.forceCollide(d=>d.r+5))
        .alpha(0.9).alphaDecay(0.02)
        .on('tick',()=>{
          gDot.attr('transform',d=>`translate(${d.x},${d.y})`);
          gDot.each(d=>posByUid.set(d.uid,{x:d.x,y:rowBaseY+d.y,rowY:rowBaseY}));
          gDot.select('circle.core').attr('r',d=>d.r).attr('fill',d=>colorForTheme(d.theme));
          const needOutline=d=>!isGETTR(d) && (statusColor(d.summarised_status)!=='transparent');
          gDot.select('circle.ring-sep').attr('r',d=>d.r+2).attr('stroke','var(--sep)').attr('opacity',d=>needOutline(d)?1:0);
          gDot.select('circle.ring-status')
            .attr('r',d=>d.r+3.6)
            .attr('stroke',d=>isGETTR(d)?'transparent':statusColor(d.summarised_status))
            .attr('opacity',d=>needOutline(d)?1:0);
        });

      pending++; sim.on('end',()=>{ if(--pending===0){ buildLegends(); buildSizeChips(); applyStoryHighlight(); filter(true); }});
    });
  }

  function showLoadingSidebars(){
    gSide.selectAll('*').remove();
    const xLeft=PLOT_W+GAP_W;
    S.platforms.forEach((plat,iRow)=>{
      const yTop=iRow*(rowH+rowGap);
      const g=gSide.append('g').attr('transform',`translate(${xLeft},${yTop})`);
      g.append('text').attr('class','panel-title').attr('x',0).attr('y',-20).text(`${plat.toUpperCase()} — CONTEXT`);
      g.append('text').attr('class','loading').attr('x',0).attr('y',18).text('Loading annotations…');
    });
  }

  /* ----- legends ----- */
  function buildLegends(){
    const themeBox=d3.select('#legend-themes'); themeBox.selectAll('*').remove();
    const themes=[...S.themes].sort();
    themeBox.selectAll('.legend-item').data(themes,d=>d).join(enter=>{
      const div=enter.append('div').attr('class','legend-item');
      div.html(d=>`<span class="swatch" style="background:${colorForTheme(d)}"></span> <span>${esc(d||'—')}</span>`);
      div.on('click',(e,d)=>{ toggleSet(S.themeFilter,d); updateLegendStates(); filter(true); });
    });

    const subBox=d3.select('#legend-subthemes'); subBox.selectAll('*').remove();
    const sts=[...S.subthemes].sort();
    subBox.selectAll('.legend-item').data(sts,d=>d).join(enter=>{
      const div=enter.append('div').attr('class','legend-item');
      div.html(d=>`<span class="swatch" style="background:#556b8e"></span> <span>${esc(d||'—')}</span>`);
      div.on('click',(e,d)=>{ toggleSet(S.subthemeFilter,d); updateLegendStates(); filter(true); });
    });

    const statBox=d3.select('#legend-status'); statBox.selectAll('*').remove();
    const status=[...S.statuses].sort();
    statBox.selectAll('.legend-item').data(status,d=>d).join(enter=>{
      const div=enter.append('div').attr('class','legend-item');
      div.html(d=>{
        const c=statusColor(d);
        const style=c==='transparent'?'border:2px dashed #567; opacity:.6':`border:2px solid ${c}`;
        return `<span class="stroke" style="${style}"></span> <span>${esc(d||'—')}</span>`;
      });
      div.on('click',(e,d)=>{ toggleSet(S.statusFilter,d); updateLegendStates(); filter(true); });
    });

    function updateLegendStates(){
      d3.select('#legend-themes').selectAll('.legend-item').classed('dim', d=> S.themeFilter.size && !S.themeFilter.has(d));
      d3.select('#legend-status').selectAll('.legend-item').classed('dim', d=> S.statusFilter.size && !S.statusFilter.has(d));
      d3.select('#legend-subthemes').selectAll('.legend-item').classed('dim', d=> S.subthemeFilter.size && !S.subthemeFilter.has(d));
    }
    function toggleSet(s,v){ s.has(v)?s.delete(v):s.add(v); }
  }

  function buildSizeChips(){
    const box=document.getElementById('size-chips'); box.innerHTML='';
    const fmt=d3.format(',');
    S.platforms.forEach(p=>{
      const vals=S.raw.filter(d=>d.platform===p && isFinite(d.engagement_num) && d.engagement_num>0).map(d=>d.engagement_num);
      const min=(vals.length?d3.min(vals):1), max=(vals.length?d3.max(vals):1);
      const r = rByPlat && rByPlat.get(p) ? rByPlat.get(p) : d3.scaleSqrt().domain([1,max]).range([3,11]);
      const chip=document.createElement('div'); chip.className='chip';
      chip.appendChild(document.createTextNode(p));
      const svg=d3.create('svg');
      svg.append('circle').attr('cx',12).attr('cy',8).attr('r',r(min)).attr('fill','#5a7');
      svg.append('circle').attr('cx',36).attr('cy',8).attr('r',r(max)).attr('fill','#5a7');
      chip.appendChild(svg.node());
      const nums=document.createElement('span'); nums.textContent=`${fmt(min)}–${fmt(max)}`; chip.appendChild(nums);
      box.appendChild(chip);
    });
  }

  /* ----- stories legend ----- */
  function buildStoriesLegend(){
    const el=d3.select('#legend-stories'); el.selectAll('*').remove();
    const stories=['All', STORY_PLANNING, STORY_MILITARY, STORY_FRAUD];
    el.selectAll('.story-item').data(stories).join('div')
      .attr('class','story-item')
      .classed('active', d=>d===S.activeStory)
      .text(d=>d)
      .on('click',(e,d)=>{
        S.activeStory=d; d3.selectAll('.story-item').classed('active', x=>x===d);
        gOverlay.selectAll('*').remove(); gSide.selectAll('*').remove(); gLines.selectAll('*').remove();
        if (d!=='All') showLoadingSidebars();
        if(d===STORY_PLANNING){
          const max=d3.max(S.raw,x=>x.date); const start=new Date('2022-12-15T00:00:00');
          S.from=start; S.to=max;
          document.getElementById('from-date').value=start.toISOString().slice(0,10);
          document.getElementById('to-date').value=max.toISOString().slice(0,10);
        }else{
          const min=d3.min(S.raw,x=>x.date), max=d3.max(S.raw,x=>x.date);
          S.from=min; S.to=max;
          document.getElementById('from-date').value=min.toISOString().slice(0,10);
          document.getElementById('to-date').value=max.toISOString().slice(0,10);
        }
        rebuild();
      });
  }

  /* ----- story highlight rules ----- */
  function applyStoryHighlight(){
    const isPlanning=S.activeStory===STORY_PLANNING;
    const isMilitary=S.activeStory===STORY_MILITARY;
    const isFraud=S.activeStory===STORY_FRAUD;
    gRows.selectAll('g.dot').classed('dimStory', d=>{
      if (isPlanning) return !planningThemes.has(d.theme);
      if (isMilitary) return !militarySubthemes.has(d.subtheme);
      if (isFraud)    return d.theme !== 'Allegations of election fraud'; // highlight by THEME
      return false;
    });
  }

  /* ----- sidebars (visible items only) ----- */
  function rebuildSidebars(){
    gLines.selectAll('*').remove(); gOverlay.selectAll('*').remove(); gSide.selectAll('*').remove();
    if (S.activeStory==='All') return;

    const textFor = d => S.annoLang==='pt' ? d.context_pt : d.context_en;
    const perRow = new Map(S.platforms.map(p=>[p,[]]));

    S.data.forEach(d=>{
      const txt=(textFor(d)||'').trim(); if(!txt) return;
      if(S.activeStory===STORY_PLANNING && d.story!==STORY_PLANNING) return;
      if(S.activeStory===STORY_MILITARY && d.story!==STORY_MILITARY) return;
      // Fraud story limited by THEME (not by Story column)
      if(S.activeStory===STORY_FRAUD && d.theme !== 'Allegations of election fraud') return;
      if(!datumVisible(d)) return;
      perRow.get(d.platform)?.push(d);
    });

    const fmtDate=d3.timeFormat('%b %d');
    S.platforms.forEach((plat,iRow)=>{
      const items=(perRow.get(plat)||[]).sort((a,b)=>a.date-b.date);
      if(!items.length) return;

      const xLeft=PLOT_W+GAP_W, yTop=iRow*(rowH+rowGap);
      const gCol=gSide.append('g').attr('transform',`translate(${xLeft},${yTop})`);
      gCol.append('text').attr('class','panel-title').attr('x',0).attr('y',-22).text(`${plat.toUpperCase()} — CONTEXT`);

      // Larger chips + spacing + more lanes (prevents overlaps)
      const chipH = 68, chipGap = 24, lanes = Math.min(6, Math.ceil(items.length/7) || 1);
      const laneW=Math.floor(SIDE_W/lanes)-(lanes>1?10:0);
      const laneX=i=>i*(laneW+10); const laneY=Array(lanes).fill(18);

      const overlayRow=gOverlay.append('g');
      let expandedFor=null, expandedGroup=null, connector=null;

      items.forEach(d=>{
        let k=0,best=laneY[0]; for(let i=1;i<lanes;i++){ if(laneY[i]<best){best=laneY[i];k=i;} }
        const g=gCol.append('g').attr('class','chip-g').style('cursor','pointer')
                     .attr('transform',`translate(${laneX(k)},${laneY[k]})`);
        const label=fmtDate(d.date).toUpperCase();
        const tmp=g.append('text').text(label).attr('opacity',0);
        const w=Math.max(96,tmp.node().getComputedTextLength()+34); tmp.remove();
        g.append('rect').attr('width',w).attr('height',chipH).attr('rx',12).attr('ry',12);
        g.append('text').attr('x',w/2).attr('y',chipH/2+10).attr('text-anchor','middle').text(label);
        laneY[k]+=chipH+chipGap;

        // Toggle open/close reliably & prevent bubbling
        g.on('click',(e)=>{
          e.stopPropagation();
          toggleExpand(d);
        });

        function toggleExpand(datum){
          if(expandedFor===datum.uid){
            expandedFor=null;
            if(expandedGroup){expandedGroup.remove(); expandedGroup=null;}
            if(connector){connector.remove(); connector=null;}
            return;
          }

          expandedFor=datum.uid;
          if(expandedGroup){expandedGroup.remove();}
          if(connector){connector.remove();}

          expandedGroup = overlayRow.append('g').attr('class','xchip');

          const bodyText=(textFor(datum)||'').trim();
          const x=xLeft, y=yTop+18, maxW=SIDE_W;
          const label = fmtDate(datum.date).toUpperCase();

          // Create rect first (resized after measuring)
          const rect = expandedGroup.append('rect')
            .attr('width', maxW)
            .attr('height', 10)
            .attr('rx', 16).attr('ry', 16);

          // Header + close (bigger padding)
          expandedGroup.append('text').attr('x',28).attr('y',40).text(`${label} — ${datum.platform}`);
          expandedGroup.append('text').attr('class','xbtn')
            .attr('x',maxW-28).attr('y',38)
            .text('×')
            .on('click',()=>toggleExpand(datum));

          // Body with larger line height and padding
          const body=expandedGroup.append('text').attr('x',28).attr('y',78);
          wrapSvgText(body, maxW-56, 32, 220, bodyText);

          // Height: header(44) + gap(12) + lines*32 + bottom(30)
          const lines=body.selectAll('tspan').nodes().length||1;
          const boxH=44 + 12 + (lines*32) + 30;
          rect.attr('height', boxH);

          // Position in sidebar
          expandedGroup.attr('transform',`translate(${x},${y})`);

          // Connector curve from dot to box
          const pos=posByUid.get(datum.uid);
          if(pos){
            const x1=pos.x, y1=pos.y, x2=PLOT_W+GAP_W-14, y2=y+boxH/2;
            connector=gLines.append('path')
              .attr('d',`M${x1},${y1} C ${x1+40},${y1} ${x2-40},${y2} ${x2},${y2}`)
              .attr('stroke','#6fa7ff').attr('stroke-width',2.2).attr('fill','none').attr('marker-end','url(#arrow)');
          }
        }
      });
    });

    // Click anywhere outside to close any open card
    document.addEventListener('click', () => { gOverlay.selectAll('*').remove(); gLines.selectAll('*').remove(); }, { once:true });
  }

  function wrapSvgText(sel, width, lineH, maxLines, rawText){
    sel.each(function(){
      const text=d3.select(this).text('');
      const words=(rawText||'').split(/\s+/).filter(Boolean);
      let line=[], ln=0; let tspan=text.append('tspan').attr('x',20).attr('dy',lineH).text('');
      for(const w of words){
        line.push(w); tspan.text(line.join(' '));
        if(tspan.node().getComputedTextLength()>width){
          line.pop(); tspan.text(line.join(' '));
          line=[w]; tspan=text.append('tspan').attr('x',20).attr('dy',lineH).text(w);
          ln++; if(ln>maxLines){ tspan.text('…'); break; }
        }
      }
    });
  }

  function filter(rebuildSB){
    gRows.selectAll('g.dot').classed('hidden', d=>!datumVisible(d));
    if (S.activeStory!=='All' && rebuildSB) rebuildSidebars();
  }

  function applyRange(){
    const fromV=document.getElementById('from-date').value;
    const toV=document.getElementById('to-date').value;
    S.from = fromV ? new Date(fromV+'T00:00:00') : null;
    S.to   = toV   ? new Date(toV+'T23:59:59')  : null;
    gOverlay.selectAll('*').remove(); gLines.selectAll('*').remove(); gSide.selectAll('*').remove();
    if (S.activeStory!=='All') showLoadingSidebars();
    rebuild();
  }

  // Tooltip (post hover)
  const fmt=d3.format(',');
  function showTooltip(evt,d){
    const el=tooltip; el.classList.remove('hidden');
    const post = (S.postLang==='pt'? d.post_pt : d.post_en) || '(no text)';
    const label = ENG_LABEL.get(d.platform) || 'Engagement';
    const totalStr = (d.platform==='GETTR') ? 'No engagement'
                   : (d.engagement_raw && d.engagement_raw.trim()==='?') ? '?'
                   : fmt(Math.round(d.engagement_num||0));
    const mx=maxByPlat.get(d.platform)||1;
    const norm = (d.platform==='GETTR') ? null : (isFinite(d.engagement_num) && mx>0 ? Math.round(d.engagement_num/mx*100) : null);
    const normStr = (d.platform==='GETTR') ? '—' : (isFinite(norm)? `${norm}% of platform max` : '—');

    el.innerHTML = [
      `<p style="margin:0 0 8px">${esc(post)}</p>`,
      `<div><b>Detailed status:</b> ${esc(d.detailed_status||'—')}</div>`,
      `<div><b>${esc(label)}:</b> ${esc(totalStr)}</div>`,
      `<div><b>Normalised:</b> ${esc(normStr)}</div>`
    ].join('');

    const {pageX:x,pageY:y}=evt; const maxW=640;
    el.style.left=Math.min(window.innerWidth-maxW-20,x+16)+'px';
    el.style.top=(y+16)+'px';
  }
  function hideTooltip(){ tooltip.classList.add('hidden'); }

  // Open Annex (or URL)
  function openDetails(d){
    const annex=(d.annex||'').trim(); const url=(d.link||'').trim(); const best=annex?annex:(url?url:null);
    if(!best) return; window.open(best,'_blank','noopener');
  }

})();
</script>
</body>
</html>
