<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BR Jan 8 — All Platforms • Remote CSV interactive beeswarms</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0f14; --panel:#0f1622; --stroke:#213248; --fg:#e6eef7; --muted:#9fb3c8; --accent:#7cc4ff;}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent)}
  .wrap{max-width:1680px;margin:24px auto 90px;padding:0 16px}
  header h1{margin:.2rem 0 .1rem;font-size:24px}
  header p{margin:0 0 8px;color:var(--muted)}

  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:10px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;background:#0e1520;color:var(--fg);font-size:13px}
  select,input[type="date"]{border-radius:10px;border:1px solid var(--stroke);background:#0e1520;color:var(--fg);padding:8px 10px;font-weight:600}
  button{border-radius:10px;border:1px solid var(--stroke);background:#0e1520;color:var(--fg);padding:8px 10px;font-weight:600}

  .viz{margin-top:12px;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:12px}
  svg{width:100%;height:auto;display:block}
  .axis text{fill:var(--muted);font-size:12px}
  .axis path,.axis line{stroke:#33465e}
  .track{stroke:#1a2433;stroke-width:1}
  .platform-label{fill:#9fb3c8;font-size:13px}

  .legend-top{display:block; margin-top:12px}
  .legend-top .section{border:1px solid var(--stroke);border-radius:12px;padding:12px 12px 14px;background:#0e1520;margin-bottom:12px}
  .legend-top h3{font-size:13px;margin:0 0 10px;color:var(--muted);font-weight:700}
  .legend-top .legend-row{display:flex;flex-wrap:wrap;gap:10px 16px;align-items:center}

  .legend-item{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--fg);cursor:pointer}
  .legend-item .swatch{width:14px;height:14px;border-radius:50%;border:1.5px solid #fff3}
  .legend-item .stroke{border-radius:3px;height:10px;width:22px;background:transparent}
  .legend-item.dim{opacity:.35}
  .explain{margin:.2rem 0 .8rem;color:#9fb3c8;font-size:12px}

  .size-chips{display:flex;flex-wrap:wrap;gap:10px 16px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border:1px solid var(--stroke);border-radius:999px;background:#0e1520;color:#9fb3c8;font-size:12px;white-space:nowrap}
  .chip svg{width:40px;height:14px}

  .story-item{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--stroke);border-radius:12px;background:#0e1520;color:var(--fg);cursor:pointer;font-size:12px}
  .story-item.active{outline:2px solid #6fa7ff}

  .tool{position:absolute;pointer-events:none;background:#0d1521;color:var(--fg);border:1px solid var(--stroke);border-radius:10px;padding:10px 12px;font-size:13px;line-height:1.35;max-width:420px;box-shadow:0 10px 30px #0006}
  .tool h4{margin:0 0 6px;font-size:13px;color:var(--accent)}
  .tool p{margin:0 0 6px;white-space:pre-wrap}
  .tool .meta{color:var(--muted);font-size:12px}

  .panel-title{fill:#9fb3c8; font-size:11px}

  /* Chips */
  .chip-g rect{fill:#0b1220; stroke:#6fa7ff; stroke-width:1.2}
  .chip-g text{fill:#e6eef7; font-size:13px}

  /* Expanded chip overlay (full text) */
  .xchip rect{fill:#0b1220; stroke:#6fa7ff; stroke-width:1.6}
  .xchip text{fill:#e6eef7; font-size:14px}
  .xbtn{fill:#cfe2ff; font-size:16px; cursor:pointer}
  .hidden{display:none}
  .dimStory{opacity:.25}
  .loading{fill:#9fb3c8;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Top posts leading up to Jan 8, 2023 — all platforms</h1>
    <p>Each dot is a post. <b>Dot area ∝ Overall engagement</b> (per‑platform). <b>Fill = Theme</b>. <b>Outer ring = Status</b>. Click any dot to open its source.</p>
  </header>

  <div class="controls">
    <label class="pill">Annotation language
      <select id="anno-lang"><option value="en" selected>English</option><option value="pt">Português</option></select>
    </label>
    <label class="pill">Post language
      <select id="post-lang"><option value="pt">Português</option><option value="en" selected>English</option></select>
    </label>

    <label class="pill">From
      <input id="from-date" type="date"/>
    </label>
    <label class="pill">To
      <input id="to-date" type="date"/>
    </label>
    <button id="apply-range">Apply range</button>

    <input id="search" placeholder="Search (post / theme / status / link)" style="flex:1;background:#0e1520;color:var(--fg);border:1px solid var(--stroke);border-radius:10px;padding:8px 10px"/>
    <button id="btn-export">Export PNG</button>
  </div>

  <div class="legend-top">
    <div class="section">
      <h3>What you are seeing</h3>
      <p class="explain">
        Dots are posts. <b>Dot size</b>: Overall engagement (normalised per platform).
        <b>Fill</b>: Theme. <b>Outer ring</b>: Summarised status.
      </p>
      <div id="size-chips" class="size-chips"></div>
    </div>

    <div class="section">
      <h3>Stories</h3>
      <div id="legend-stories" class="legend-row"></div>
    </div>

    <div class="section">
      <h3>Themes (click to filter)</h3>
      <div id="legend-themes" class="legend-row"></div>
    </div>

    <div class="section">
      <h3>Sub‑themes (click to filter)</h3>
      <div id="legend-subthemes" class="legend-row"></div>
    </div>

    <div class="section">
      <h3>Status (click to filter)</h3>
      <div id="legend-status" class="legend-row"></div>
    </div>
  </div>

  <div class="viz">
    <svg id="chart" viewBox="0 0 1900 1400" preserveAspectRatio="xMidYMid meet" aria-label="Beeswarm chart"></svg>
  </div>
</div>

<div id="tooltip" class="tool hidden"></div>

<script>
(() => {
  // ------- Layout -------
  const SIDE_W = 320, GAP_W = 100, PLOT_W = 1400;
  const W = 120 + PLOT_W + GAP_W + SIDE_W + 28;
  const M={t:170,r:28,b:90,l:120};
  const rowH = 160, rowGap = 120;

  const DEFAULT_CSV_URL = "https://raw.githubusercontent.com/edekeulenaar/normative_dislocation/main/Annex%20-%20Beeswarm%20graph%20(Top%20~500%20per%20platform)%20-%2031%20Oct-10%20Jan%202023%20-%20Final%20spreadsheet%20for%20article%20viz.csv";
  const CSV_URL = new URLSearchParams(location.search).get('csv') || DEFAULT_CSV_URL;

  const COLS = {
    date:['Date'],
    anno_en:['Annotation','Annotations','Annotations (English)'],
    anno_pt:['Annotation in Portuguese','Annotations in Portuguese'],
    platform:['Platform'],
    engagement:['Overall engagement'],
    post_pt:['Post in Portuguese'],
    post_en:['Post in English'],
    theme:['Theme'],
    subtheme:['Sub-theme','Subtheme'],
    detailed_status:['Detailed status as of January 18'],
    summarised_status:['Summarised status'],
    annex:['Annex','Appendix'],
    link:['URL','Link'],
    story:['Story']
  };

  const STATUS_COLORS = new Map([
    ['Removed by the user',    '#C96918'],
    ['Removed by platform',    '#E1524A'],
    ['Removed by the platform','#E1524A'],
    ['Removed',                '#E1524A'],
    ['Labelled',               '#FFBD4A'],
    ['Labeled',                '#FFBD4A'],
    ['Online',                 'transparent'],
    ['Unknown',                '#9aa8bb']
  ]);
  const themeColor = d3.scaleOrdinal(
    d3.schemeTableau10.concat(['#e07a5f','#3d405b','#81b29a','#f2cc8f','#f4a261','#2a9d8f','#e76f51','#a7c957','#bc6c25','#6d597a'])
  );

  const STORY_PLANNING = 'Planning the riots';
  const STORY_MILITARY = 'Military involvement';
  const planningThemes = new Set([
    'Calls for a military intervention',
    'Calls to join the January 8 riots',
    'Prophecising a coup',
    'References to, or calls for, a civil war',
    'Strikes in support of a military coup'
  ]);
  const militarySubthemes = new Set(['Military support','Military barracks']);

  // SVG & layers
  const $svg = d3.select('#chart').attr('viewBox',`0 0 ${W} 1400`);
  const defs = $svg.append('defs');
  defs.append('marker').attr('id','arrow').attr('viewBox','0 0 10 10')
    .attr('refX',10).attr('refY',5).attr('markerWidth',7).attr('markerHeight',7).attr('orient','auto')
    .append('path').attr('d','M 0 0 L 10 5 L 0 10 z').attr('fill','#6fa7ff');

  const gRoot = $svg.append('g').attr('transform',`translate(${M.l},${M.t})`);
  const gPlot = gRoot.append('g');
  const gAxisTop = gPlot.append('g').attr('class','axis');
  const gRows = gPlot.append('g');

  const gLines = gRoot.append('g');     // connectors
  const gSideRoot = gRoot.append('g');  // chips & placeholders
  const gOverlay = gRoot.append('g');   // expanded cards

  const tooltip = document.getElementById('tooltip');

  // State
  const S={
    raw:[], data:[], platforms:[], themes:new Set(), subthemes:new Set(), statuses:new Set(),
    activeStory:'All',
    themeFilter:new Set(), subthemeFilter:new Set(), statusFilter:new Set(),
    search:'', annoLang:'en', postLang:'en', from:null, to:null
  };

  // Controls
  document.getElementById('anno-lang').onchange=e=>{S.annoLang=e.target.value; rebuildSidebars();};
  document.getElementById('post-lang').onchange=e=>{S.postLang=e.target.value;};
  document.getElementById('btn-export').onclick=exportPNG;
  document.getElementById('apply-range').onclick=applyRange;
  let deb; document.getElementById('search').addEventListener('input',()=>{clearTimeout(deb);deb=setTimeout(()=>{S.search=(document.getElementById('search').value||'').toLowerCase().trim(); filter(true);},160)});

  // Utils
  const esc = s => (s==null?'':String(s)).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const isGETTR = d => (d.platform||'').toLowerCase()==='gettr';
  function col(r,keys){for(const k of keys){if(r[k]!=null&&String(r[k]).trim()!=='')return String(r[k]).trim();}return'';}
  function num(r,keys){const v=col(r,keys);if(v==='')return NaN;const nv=+String(v).replace(/\u00A0/g,' ').replace(/[^\d.\-]/g,'');return isFinite(nv)?nv:NaN;}
  function parseDate(s){if(!s)return null;let d=new Date(s);if(!isNaN(+d))return d;const fmts=['%Y-%m-%d %H:%M:%S','%Y-%m-%d','%d/%m/%Y %H:%M','%d/%m/%Y'];for(const f of fmts){const p=d3.timeParse(f);d=p(s);if(d)return d;}return null;}
  function statusColor(st){ if (!st) return '#9aa8bb'; if (STATUS_COLORS.has(st)) return STATUS_COLORS.get(st); return '#9aa8bb'; }

  // Visibility test (filters/search)
  function datumVisible(d){
    if(S.themeFilter.size && !S.themeFilter.has(d.theme)) return false;
    if(S.statusFilter.size && !S.statusFilter.has(d.summarised_status)) return false;
    if(S.subthemeFilter.size && !S.subthemeFilter.has(d.subtheme)) return false;
    if(S.search){
      const hay=[d.post_en,d.post_pt,(d.context_en||''),(d.context_pt||''),d.theme,d.subtheme,d.summarised_status,d.link,d.annex].join(' ').toLowerCase();
      if(!hay.includes(S.search)) return false;
    }
    return true;
  }

  // Load CSV
  fetch(CSV_URL,{cache:"no-store"}).then(r=>r.text()).then(text=>{
    const header=(text.split(/\r?\n/)[0]||""); const delim=header.includes(";")?";":",";
    const rows=d3.dsvFormat(delim).parse(text); ingest(rows);
  }).catch(err=>banner("Could not load CSV. Ensure the GitHub raw URL is public. "+err.message));

  function banner(msg){
    const d=document.createElement('div');
    d.style.cssText="margin-top:10px;padding:10px;border:1px solid #513; background:#1a0f0f;color:#ffd7d7;border-radius:10px";
    d.textContent=msg; document.querySelector('.wrap').prepend(d);
  }

  function ingest(rows){
    const clean=rows.map((r,i)=>{
      const date=parseDate(col(r,COLS.date)); if(!date) return null;
      const storyRaw=(col(r,COLS.story)||'').trim();
      const story = storyRaw==='Story 1' ? STORY_PLANNING
                   : storyRaw==='Story 2' ? STORY_MILITARY
                   : storyRaw;
      return {
        uid:i,
        date,
        platform:col(r,COLS.platform)||'Unknown',
        engagement:num(r,COLS.engagement)||0,
        theme:col(r,COLS.theme)||'—',
        subtheme:col(r,COLS.subtheme)||'—',
        post_en:col(r,COLS.post_en),
        post_pt:col(r,COLS.post_pt),
        context_en:col(r,COLS.anno_en),
        context_pt:col(r,COLS.anno_pt),
        story,
        detailed_status:col(r,COLS.detailed_status),
        summarised_status:col(r,COLS.summarised_status)||'Unknown',
        annex:col(r,COLS.annex),
        link:col(r,COLS.link)
      };
   
